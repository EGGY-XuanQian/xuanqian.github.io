<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文件下载中心</title>

  <style>
    @font-face {
      font-family: 'U5Font';
      src: url('./Web/U5Font_Round_7744b500.ttf') format('truetype');
    }
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    body {
      font-family: 'U5Font', sans-serif;
      background-color: var(--bg);
      color: var(--text);
    }

    :root {
      --bg: #f5f5f5;
      --text: #222;
      --card: white;
      --nav: #4285F4;
      --btn: #34A853;
    }

    body.dark {
      --bg: #121212;
      --text: #e0e0e0;
      --card: #1e1e1e;
      --nav: #1f1f1f;
      --btn: #4CAF50;
    }

    nav { background-color: var(--nav); }

    .brand-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.4rem;
    }

    .dark-toggle {
      position: absolute;
      right: 16px;
      top: 12px;
      cursor: pointer;
    }

    .material-symbols-outlined {
      font-size: 24px;
      vertical-align: middle;
    }

    .card {
      background-color: var(--card);
      color: var(--text);
    }

    .card-title {
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .download-btn { background-color: var(--btn) !important; }

    .file-tag {
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      color: white;
      margin-bottom: 8px;
      display: inline-block;
    }

    .view-toggle, .sort-toggle {
      margin-bottom: 20px;
      text-align: right;
    }

    .not-found {
      text-align: center;
      font-size: 1.2rem;
      margin-top: 40px;
    }

    .fade-out {
      opacity: 0;
      transform: scale(0.98);
      transition: all 0.15s ease-out;
    }

    .fade-in {
      opacity: 1;
      transform: scale(1);
      transition: all 0.25s ease-out;
    }

    #preview-modal {
      max-height: 80vh;
      overflow-y: auto;
      background: var(--card);
      color: var(--text);
      padding: 20px;
    }
  </style>
</head>

<body>

  <nav>
    <div class="nav-wrapper container">
      <a href="#" class="brand-logo">
        <span class="material-symbols-outlined">folder</span>
        文件下载中心
      </a>
      <span class="material-symbols-outlined dark-toggle" onclick="toggleDarkMode()">dark_mode</span>
    </div>
  </nav>

  <div class="container">

    <div class="row search-box">
      <div class="input-field col s9">
        <input id="search" type="text" placeholder="搜索文件...">
      </div>
      <div class="input-field col s3">
        <button class="btn blue" onclick="triggerSearch()">搜索</button>
      </div>
    </div>

    <div class="view-toggle">
      <a id="btn-grid" class="btn-small blue" onclick="setView('grid')">网格视图</a>
      <a id="btn-list" class="btn-small blue lighten-2" onclick="setView('list')">列表视图</a>
    </div>

    <div class="sort-toggle">
      <a class="btn-small grey" onclick="sortFiles('name')">按名称</a>
      <a class="btn-small grey" onclick="sortFiles('size')">按大小</a>
      <a class="btn-small grey" onclick="sortFiles('type')">按类型</a>
    </div>

    <h5 class="center-align">Code 文件夹内容</h5>
    <div id="file-list" class="row"></div>
    <div id="not-found" class="not-found" style="display:none;">未找到文件</div>
  </div>

  <div id="preview-modal" class="modal">
    <div class="modal-content">
      <h5 id="preview-title"></h5>
      <pre><code id="preview-content"></code></pre>
    </div>
    <div class="modal-footer">
      <a class="modal-close btn blue">关闭</a>
    </div>
  </div>

  <script>
    let allFiles = [];
    let currentView = 'grid';
    let sortMode = 'name';

    document.addEventListener("DOMContentLoaded", () => {
      loadFiles();
      M.Modal.init(document.querySelectorAll('.modal'));
      if (localStorage.getItem("dark") === "1") document.body.classList.add("dark");
    });

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
      localStorage.setItem("dark", document.body.classList.contains("dark") ? "1" : "0");
    }

    function getIconByFileType(name) {
      const ext = name.split('.').pop().toLowerCase();
      if (["png","jpg","jpeg","gif","svg"].includes(ext)) return "image";
      if (["mp3","wav"].includes(ext)) return "audio_file";
      if (["mp4","avi"].includes(ext)) return "movie";
      if (["zip","rar","7z"].includes(ext)) return "folder_zip";
      if (["txt","md","json","xml","py"].includes(ext)) return "description";
      return "insert_drive_file";
    }

    function getTagColor(ext) {
      if (["png","jpg","jpeg","gif","svg"].includes(ext)) return "#1E88E5";
      if (["zip","rar","7z"].includes(ext)) return "#8E24AA";
      if (["txt","md","json","xml","py"].includes(ext)) return "#43A047";
      return "#757575";
    }

    function setView(view) {
      currentView = view;

      document.getElementById("btn-grid").classList.remove("blue");
      document.getElementById("btn-list").classList.remove("blue");

      if (view === "grid") {
        document.getElementById("btn-grid").classList.add("blue");
        document.getElementById("btn-list").classList.add("blue", "lighten-2");
      } else {
        document.getElementById("btn-list").classList.add("blue");
        document.getElementById("btn-grid").classList.add("blue", "lighten-2");
      }

      const list = document.getElementById("file-list");
      list.classList.add("fade-out");

      setTimeout(() => {
        renderFiles(allFiles);
        list.classList.remove("fade-out");
        list.classList.add("fade-in");
        setTimeout(() => list.classList.remove("fade-in"), 300);
      }, 150);
    }

    function sortFiles(mode) {
      sortMode = mode;
      if (mode === "name") allFiles.sort((a,b)=>a.name.localeCompare(b.name));
      if (mode === "size") allFiles.sort((a,b)=>a.size - b.size);
      if (mode === "type") allFiles.sort((a,b)=>a.name.split('.').pop().localeCompare(b.name.split('.').pop()));
      renderFiles(allFiles);
    }

    function triggerSearch() {
      const keyword = document.getElementById("search").value.toLowerCase();
      const filtered = allFiles.filter(f => f.name.toLowerCase().includes(keyword));
      renderFiles(filtered);
    }

    async function loadFiles() {
      const repo = "EGGY-XuanQian/eggy-xuanqian.github.io";
      const path = "Code";
      const response = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`);
      const files = await response.json();
      allFiles = files;
      sortFiles("name");
    }

    function renderFiles(files) {
      const list = document.getElementById("file-list");
      const notFound = document.getElementById("not-found");
      list.innerHTML = "";
      notFound.style.display = files.length ? "none" : "block";

      files.forEach(file => {
        const ext = file.name.split('.').pop().toLowerCase();
        const icon = getIconByFileType(file.name);
        const tagColor = getTagColor(ext);
        const sizeKB = (file.size / 1024).toFixed(1);

        const downloadURL = `https://github.com/EGGY-XuanQian/eggy-xuanqian.github.io/raw/main/Code/${file.name}`;

        const card = document.createElement("div");
        card.className = currentView === 'list' ? "col s12 list-view" : "col s12 m6 l4";

        card.innerHTML = `
          <div class="card hoverable" onclick="previewFile('${downloadURL}', '${file.name}')">
            <div class="card-content">
              <span class="file-tag" style="background:${tagColor}">${ext.toUpperCase()}</span>
              <span class="card-title">
                <span class="material-symbols-outlined">${icon}</span>
                ${file.name}
              </span>
              <p>大小：${sizeKB} KB</p>
            </div>
            <div class="card-action">
              <a class="btn download-btn" href="${downloadURL}" download onclick="event.stopPropagation()">下载</a>
            </div>
          </div>
        `;

        list.appendChild(card);
      });
    }

    async function previewFile(url, name) {
      const ext = name.split('.').pop().toLowerCase();
      if (!["txt","json","py","md","xml"].includes(ext)) return;

      const res = await fetch(url);
      const text = await res.text();

      document.getElementById("preview-title").innerText = name;
      document.getElementById("preview-content").innerText = text;

      hljs.highlightAll();
      const modal = M.Modal.getInstance(document.getElementById("preview-modal"));
      modal.open();
    }
  </script>

</body>
</html>
